<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCMwHzsfQZIHsEqKlkIpQNTbZxCVYhFoZ8",
        authDomain: "fila-cord.firebaseapp.com",
        projectId: "fila-cord",
        storageBucket: "fila-cord.firebasestorage.app",
        messagingSenderId: "249621709749",
        appId: "1:249621709749:web:18b6486f2095f95f29cffc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let filaCompleta = [];

    onSnapshot(query(collection(db, "fila"), orderBy("hora", "asc")), (snap) => {
        filaCompleta = snap.docs.map(d => ({id: d.id, ...d.data()}));
        renderizar();
    });

    window.renderizar = () => {
        const container = document.getElementById('lista-fila');
        const filtroSelect = document.getElementById('filtroCurso');
        const filtroTexto = filtroSelect.options[filtroSelect.selectedIndex].text; // Pega o texto exato
        
        // Filtra comparando o nome do curso exato
        const filtrados = (filtroSelect.value === "Todos") 
            ? filaCompleta 
            : filaCompleta.filter(a => a.curso === filtroTexto);
        
        document.getElementById('count-espera').innerText = filtrados.length;
        
        container.innerHTML = filtrados.map(aluno => `
            <div class="student-card ${aluno.status === 'CHAMANDO' ? 'calling' : ''}">
                <div style="font-size: 1.25rem; font-weight: 800; color: #4f46e5;">${aluno.senha}</div>
                <div>
                    <div style="font-weight: 700;">${aluno.nome}</div>
                    <div style="display: flex; gap: 8px;">
                        <span class="badge badge-course">${aluno.curso}</span>
                        ${aluno.pref ? '<span class="badge badge-pref">PREFERENCIAL</span>' : ''}
                    </div>
                </div>
                <div style="color: #64748b; font-size: 0.85rem;">
                    <b>CPF:</b> ${aluno.cpf}
                </div>
                <div style="display: flex; justify-content: flex-end;">
                    ${aluno.status !== 'CHAMANDO' 
                        ? `<button class="btn btn-call" onclick="chamar('${aluno.id}', '${aluno.nome}')">ðŸ”” CHAMAR</button>`
                        : `<button class="btn btn-finish" onclick="finalizarAtendimento('${aluno.id}')">âœ… FINALIZAR</button>`
                    }
                </div>
            </div>
        `).join('');
    };

    window.chamar = async (id, nome) => {
        await updateDoc(doc(db, "fila", id), { status: 'CHAMANDO' });
        // Som e Voz
        const voz = new SpeechSynthesisUtterance(`PrÃ³ximo atendimento: ${nome}`);
        window.speechSynthesis.speak(voz);
    };

    window.finalizarAtendimento = async (id) => {
        // Ao deletar aqui, o onSnapshot no index.html do ALUNO vai disparar a tela de avaliaÃ§Ã£o
        await deleteDoc(doc(db, "fila", id));
    };

    // Exportar Excel (mesma lÃ³gica anterior)
    window.exportarRelatorio = async () => {
        const avalSnap = await getDocs(collection(db, "avaliacoes"));
        const data = avalSnap.docs.map(d => ({
            Data: d.data().data?.toDate().toLocaleString() || 'N/A',
            Estrelas: d.data().estrelas,
            Comentario: d.data().obs || ''
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "AvaliaÃ§Ãµes");
        XLSX.writeFile(wb, "Relatorio_Fila.xlsx");
    };
</script>
