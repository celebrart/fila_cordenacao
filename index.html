<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCMwHzsfQZIHsEqKlkIpQNTbZxCVYhFoZ8",
        authDomain: "fila-cord.firebaseapp.com",
        projectId: "fila-cord",
        storageBucket: "fila-cord.firebasestorage.app",
        messagingSenderId: "249621709749",
        appId: "1:249621709749:web:18b6486f2095f95f29cffc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentId = null;
    let rating = 0;

    window.gerarSenha = async () => {
        const nome = document.getElementById('nome').value;
        const cpf = document.getElementById('cpf').value;
        const cursoEl = document.getElementById('curso');
        const cursoNome = cursoEl.options[cursoEl.selectedIndex].text; // Pega o nome legível
        const cursoSigla = cursoEl.value;
        const pref = document.getElementById('pref').checked;

        if(!nome || !cursoSigla || !cpf) return alert("Preencha os campos!");

        const prefixo = pref ? "PREF" : cursoSigla;
        const num = Math.floor(100 + Math.random() * 900);
        const senha = `${prefixo}${num}`;

        try {
            const docRef = await addDoc(collection(db, "fila"), {
                nome, cpf, curso: cursoNome, senha, pref, 
                status: "ESPERA", hora: serverTimestamp()
            });

            currentId = docRef.id;
            document.getElementById('tela-cadastro').style.display = 'none';
            document.getElementById('tela-senha').style.display = 'block';
            document.getElementById('disp-senha').innerText = senha;

            // ESCUTA ATIVA: Percebe chamadas e finalizações
            onSnapshot(doc(db, "fila", currentId), (snap) => {
                // Se o aluno foi deletado da fila (atendente finalizou)
                if(!snap.exists()) {
                    document.getElementById('tela-senha').style.display = 'none';
                    document.getElementById('tela-avaliacao').style.display = 'block';
                    return;
                }
                
                const data = snap.data();
                if(data.status === "CHAMANDO") {
                    document.getElementById('msg-status').innerText = "SUA VEZ! COMPAREÇA AO GUICHÊ";
                    document.getElementById('msg-status').style.color = "#10b981";
                    
                    // Tenta vibrar o celular e emitir som se o navegador permitir
                    window.navigator.vibrate?.([200, 100, 200]);
                    
                    if (Notification.permission === "granted") {
                        new Notification("Sua vez!", { body: `Senha ${senha}, compareça agora.` });
                    } else {
                        alert("SUA VEZ! Senha: " + senha);
                    }
                }
            });
        } catch(e) { alert("Erro ao conectar ao banco."); }
    };

    window.setRate = (n) => {
        rating = n;
        document.querySelectorAll('.estrela').forEach((el, i) => {
            el.classList.toggle('active', i < n);
        });
    }

    window.enviarAvaliacao = async () => {
        if(rating === 0) return alert("Por favor, selecione as estrelas.");
        await addDoc(collection(db, "avaliacoes"), {
            estrelas: rating,
            obs: document.getElementById('obs').value,
            data: serverTimestamp()
        });
        alert("Obrigado pela avaliação!");
        location.reload();
    }

    // Pede permissão para notificar assim que carrega
    if ("Notification" in window) { Notification.requestPermission(); }
</script>
